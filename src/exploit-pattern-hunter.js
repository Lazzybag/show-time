import 'dotenv/config';

console.log('ğŸ” EXPLOIT PATTERN HUNTER - FINDING CRITICAL VULNERABILITIES');
console.log('='.repeat(70));
console.log('Searching for ACTUAL exploitable patterns in lending markets...\n');

// TARGET: Let's find the ACTUAL vulnerable price calculation patterns
const EXPLOIT_PATTERNS = [
  'totalAssets totalSupply language:Solidity',
  'pricePerShare = totalAssets language:Solidity', 
  'convertToAssets totalSupply language:Solidity',
  'exchangeRate = totalSupply language:Solidity',
  'sharePrice = totalAssets language:Solidity',
  'getPricePerShare totalAssets language:Solidity'
];

async function huntExploitPatterns() {
  let exploitTargets = [];
  
  for (const pattern of EXPLOIT_PATTERNS) {
    console.log(`ğŸ¯ Searching for: "${pattern}"`);
    
    try {
      const response = await fetch(
        `https://api.github.com/search/code?q=${encodeURIComponent(pattern)}&per_page=20`,
        {
          headers: {
            'Authorization': `token ${process.env.GITHUB_TOKEN}`,
            'Accept': 'application/vnd.github.v3+json'
          }
        }
      );
      
      const data = await response.json();
      
      if (data.items) {
        console.log(`   Found ${data.items.length} potential exploit targets`);
        
        data.items.forEach(item => {
          // Filter for likely vulnerable implementations
          if (isLikelyVulnerable(item)) {
            exploitTargets.push({
              repo: item.repository.full_name,
              file: item.name,
              url: item.html_url,
              pattern: pattern,
              risk: 'CRITICAL',
              description: 'Direct vulnerable price calculation pattern'
            });
            console.log(`      ğŸ’€ EXPLOIT TARGET: ${item.repository.full_name}`);
            console.log(`         ğŸ“„ ${item.name}`);
            console.log(`         ğŸ”— ${item.html_url}`);
          }
        });
      }
    } catch (error) {
      console.log(`   âŒ Search failed: ${error.message}`);
    }
    
    await new Promise(resolve => setTimeout(resolve, 1200));
  }
  
  generateExploitReport(exploitTargets);
}

function isLikelyVulnerable(item) {
  const suspiciousTerms = [
    'vault', 'Vault', 'ERC4626', 'lending', 'Lending', 
    'market', 'Market', 'collateral', 'Collateral'
  ];
  
  const content = item.name + ' ' + item.path + ' ' + (item.repository.description || '');
  return suspiciousTerms.some(term => content.includes(term));
}

function generateExploitReport(targets) {
  console.log('\n' + '='.repeat(80));
  console.log('ğŸ¯ EXPLOIT PATTERN HUNTING REPORT');
  console.log('='.repeat(80));
  
  if (targets.length === 0) {
    console.log('\nâŒ No obvious exploit patterns found.');
    console.log('ğŸ’¡ The vulnerabilities might be in more complex implementations.');
    console.log('ğŸš€ Try manual code review of the integration points we found earlier.');
    return;
  }
  
  console.log(`\nğŸš¨ FOUND ${targets.length} POTENTIAL EXPLOIT TARGETS!`);
  console.log('â”€'.repeat(70));
  
  targets.forEach((target, index) => {
    console.log(`\n${index + 1}. ${target.repo}`);
    console.log(`   ğŸ“„ ${target.file}`);
    console.log(`   ğŸ”— ${target.url}`);
    console.log(`   ğŸ’€ Risk: ${target.risk}`);
    console.log(`   ğŸ¯ Pattern: ${target.pattern}`);
    console.log(`   ğŸ“ ${target.description}`);
  });
  
  console.log('\nğŸ’¼ IMMEDIATE BUSINESS OPPORTUNITY:');
  console.log('   1. These are CRITICAL vulnerabilities - immediate action required');
  console.log('   2. Prepare proof-of-concept exploits for demonstration');
  console.log('   3. Contact projects for urgent security audits');
  console.log('   4. Consider responsible disclosure process');
}

// Run the exploit hunter
huntExploitPatterns().catch(console.error);
